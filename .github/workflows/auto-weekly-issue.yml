name: Auto Create Weekly Issue

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (UTC 0ì‹œ, í•œêµ­ì‹œê°„ 9ì‹œ)
    - cron: '0 0 * * 1'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  create-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Calculate week number and dates
        id: calc
        run: |
          # í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ ì£¼ì°¨ ê³„ì‚° (1ì›” 1ì¼ ê¸°ì¤€)
          WEEK_NUM=$(date +%U)
          # ì£¼ì°¨ë¥¼ 2ìë¦¬ë¡œ í¬ë§· (01, 02, ...)
          WEEK_NUM_FORMATTED=$(printf "%02d" $((WEEK_NUM + 1)))

          # ì´ë²ˆ ì£¼ ì›”ìš”ì¼ê³¼ ì¼ìš”ì¼ ê³„ì‚°
          START_DATE=$(date -d "monday" +%Y.%m.%d)
          END_DATE=$(date -d "sunday" +%Y.%m.%d)

          echo "week_number=$WEEK_NUM_FORMATTED" >> $GITHUB_OUTPUT
          echo "start_date=$START_DATE" >> $GITHUB_OUTPUT
          echo "end_date=$END_DATE" >> $GITHUB_OUTPUT

      - name: Check for duplicate issue
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const weekNumber = '${{ steps.calc.outputs.week_number }}';
            const startDate = '${{ steps.calc.outputs.start_date }}';
            const endDate = '${{ steps.calc.outputs.end_date }}';
            const expectedTitle = `[Week${weekNumber}] ${startDate} ~ ${endDate} ì£¼ì°¨ ë¬¸ì œ`;

            // ì—´ë ¤ìˆëŠ” ì´ìŠˆ ì¤‘ì—ì„œ ê°™ì€ ì œëª©ì´ ìˆëŠ”ì§€ í™•ì¸
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              labels: 'weekly-challenge'
            });

            const duplicate = issues.find(issue => issue.title === expectedTitle);

            if (duplicate) {
              console.log(`âš ï¸ Issue already exists: ${duplicate.html_url}`);
              return 'skip';
            } else {
              console.log(`âœ… No duplicate found. Proceeding to create issue.`);
              return 'create';
            }

      - name: Create weekly issue
        if: steps.check.outputs.result == 'create'
        uses: actions/github-script@v7
        with:
          script: |
            const weekNumber = '${{ steps.calc.outputs.week_number }}';
            const startDate = '${{ steps.calc.outputs.start_date }}';
            const endDate = '${{ steps.calc.outputs.end_date }}';

            const issueBody = `## Week ${weekNumber} (${startDate} ~ ${endDate})

            ì´ë²ˆ ì£¼ ê³µí†µ ë¬¸ì œì…ë‹ˆë‹¤! ğŸ’ª

            ### ğŸ“ ë¬¸ì œ ëª©ë¡

            #### ë¬¸ì œ 1
            - **í”Œë«í¼**: ë°±ì¤€ / í”„ë¡œê·¸ë˜ë¨¸ìŠ¤ / ë¦¬íŠ¸ì½”ë“œ
            - **ë¬¸ì œ ë²ˆí˜¸**:
            - **ë¬¸ì œ ì´ë¦„**:
            - **ë‚œì´ë„**:
            - **ë§í¬**:
            - **ë¶„ë¥˜**: (ì˜ˆ: DP, ê·¸ë¦¬ë””, DFS/BFS ë“±)

            #### ë¬¸ì œ 2
            - **í”Œë«í¼**:
            - **ë¬¸ì œ ë²ˆí˜¸**:
            - **ë¬¸ì œ ì´ë¦„**:
            - **ë‚œì´ë„**:
            - **ë§í¬**:
            - **ë¶„ë¥˜**:

            #### ë¬¸ì œ 3
            - **í”Œë«í¼**:
            - **ë¬¸ì œ ë²ˆí˜¸**:
            - **ë¬¸ì œ ì´ë¦„**:
            - **ë‚œì´ë„**:
            - **ë§í¬**:
            - **ë¶„ë¥˜**:

            ---

            ### âœ… ì§„í–‰ ìƒí™©

            - [ ] @sukangpunch
            - [ ] @Hexeong
            - [ ] @whqtker
            - [ ] @JAEHEE25
            - [ ] @Gyuhyeok99

            ---

            ### ğŸ’¡ ì°¸ê³ ì‚¬í•­

            ë¬¸ì œ í’€ì´ëŠ” \`weekly/week${weekNumber}/\` ë””ë ‰í† ë¦¬ì— ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!

            \`\`\`bash
            weekly/week${weekNumber}/
            â”œâ”€â”€ BOJ_1234_ë¬¸ì œëª…/
            â”‚   â”œâ”€â”€ sukangpunch.py
            â”‚   â””â”€â”€ Hexeong.java
            â””â”€â”€ PGS_5678_ë¬¸ì œëª…/
                â””â”€â”€ whqtker.cpp
            \`\`\`

            > âš ï¸ **ë¬¸ì œ ì •ë³´ë¥¼ ì±„ì›Œì£¼ì„¸ìš”!** ì´ìŠˆ ìƒì„± í›„ ë¬¸ì œ ì •ë³´ë¥¼ í¸ì§‘í•´ì„œ ì¶”ê°€í•´ì£¼ì„¸ìš”.
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Week${weekNumber}] ${startDate} ~ ${endDate} ì£¼ì°¨ ë¬¸ì œ`,
              body: issueBody,
              labels: ['weekly-challenge']
            });

            console.log(`âœ… Week ${weekNumber} issue created!`);
