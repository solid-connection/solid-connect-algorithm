name: Create Weekly Issue

on:
  workflow_dispatch:
    inputs:
      week_number:
        description: 'ì£¼ì°¨ ë²ˆí˜¸ (ì˜ˆ: 01, 02, 03)'
        required: true
        type: string
      start_date:
        description: 'ì‹œì‘ ë‚ ì§œ (YYYY.MM.DD)'
        required: true
        type: string
      end_date:
        description: 'ì¢…ë£Œ ë‚ ì§œ (YYYY.MM.DD)'
        required: true
        type: string

jobs:
  create-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Check for duplicate issue
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const weekNumber = '${{ inputs.week_number }}';
            const startDate = '${{ inputs.start_date }}';
            const endDate = '${{ inputs.end_date }}';
            const expectedTitle = `[Week${weekNumber}] ${startDate} ~ ${endDate} ì£¼ì°¨ ë¬¸ì œ`;

            // ëª¨ë“  ì´ìŠˆ ì¤‘ì—ì„œ ê°™ì€ ì œëª©ì´ ìˆëŠ”ì§€ í™•ì¸
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              labels: 'weekly-challenge'
            });

            const duplicate = issues.find(issue => issue.title === expectedTitle);

            if (duplicate) {
              console.log(`âš ï¸ Issue already exists: ${duplicate.html_url}`);
              core.setFailed(`ì¤‘ë³µëœ ì´ìŠˆê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤: ${duplicate.html_url}`);
              return 'skip';
            } else {
              console.log(`âœ… No duplicate found. Proceeding to create issue.`);
              return 'create';
            }

      - name: Create weekly issue
        if: steps.check.outputs.result == 'create'
        uses: actions/github-script@v7
        with:
          script: |
            const weekNumber = '${{ inputs.week_number }}';
            const startDate = '${{ inputs.start_date }}';
            const endDate = '${{ inputs.end_date }}';

            const issueBody = `## Week ${weekNumber} (${startDate} ~ ${endDate})

            ì´ë²ˆ ì£¼ ê³µí†µ ë¬¸ì œì…ë‹ˆë‹¤! ğŸ’ª

            ### ğŸ“ ë¬¸ì œ ëª©ë¡

            #### ë¬¸ì œ 1
            - **í”Œë«í¼**: ë°±ì¤€ / í”„ë¡œê·¸ë˜ë¨¸ìŠ¤ / ë¦¬íŠ¸ì½”ë“œ
            - **ë¬¸ì œ ë²ˆí˜¸**:
            - **ë¬¸ì œ ì´ë¦„**:
            - **ë‚œì´ë„**:
            - **ë§í¬**:

            #### ë¬¸ì œ 2
            - **í”Œë«í¼**:
            - **ë¬¸ì œ ë²ˆí˜¸**:
            - **ë¬¸ì œ ì´ë¦„**:
            - **ë‚œì´ë„**:
            - **ë§í¬**:

            #### ë¬¸ì œ 3
            - **í”Œë«í¼**:
            - **ë¬¸ì œ ë²ˆí˜¸**:
            - **ë¬¸ì œ ì´ë¦„**:
            - **ë‚œì´ë„**:
            - **ë§í¬**:

            ---

            ### âœ… ì§„í–‰ ìƒí™©

            - [ ] @sukangpunch
            - [ ] @Hexeong
            - [ ] @whqtker
            - [ ] @JAEHEE25
            - [ ] @Gyuhyeok99

            ---

            ### ğŸ’¡ ì°¸ê³ ì‚¬í•­

            ë¬¸ì œ í’€ì´ëŠ” \`weekly/week${weekNumber}/\` ë””ë ‰í† ë¦¬ì— ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!

            \`\`\`bash
            weekly/week${weekNumber}/
            â”œâ”€â”€ BOJ_1234_ë¬¸ì œëª…/
            â”‚   â”œâ”€â”€ gyuhyeok99.py
            â”‚   â””â”€â”€ member2.java
            â””â”€â”€ PGS_5678_ë¬¸ì œëª…/
                â””â”€â”€ member3.cpp
            \`\`\`
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Week${weekNumber}] ${startDate} ~ ${endDate} ì£¼ì°¨ ë¬¸ì œ`,
              body: issueBody,
              labels: ['weekly-challenge']
            });
